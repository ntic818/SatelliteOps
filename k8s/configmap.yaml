apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: default
data:
  config.yaml: |
    topics:
      raw: telemetry.raw
      power: telemetry.power
      health: telemetry.health
      attitude: telemetry.attitude
      environment: telemetry.environment
      vsat: telemetry.vsat

    queues:
      raw: telemetry_raw_queue
      power: telemetry_power_queue
      health: telemetry_health_queue
      attitude: telemetry_attitude_queue
      environment: telemetry_environment_queue
      vsat: telemetry_vsat_queue

    llm_queues:
      raw: llm_raw_queue
      power: llm_power_queue
      health: llm_health_queue
      attitude: llm_attitude_queue
      environment: llm_environment_queue
      vsat: llm_vsat_queue

    vsats:
      vsat_1:
        ip: 81.199.32.65
        community: public
        oids:
          signal_strength: 1.3.6.1.4.1.1000.1.1
          tx_power: 1.3.6.1.4.1.7352.3.5.10.16.9.0
          rx_power: 1.3.6.1.4.1.7352.3.5.10.16.8.0

      vsat_2:
        ip: 81.199.153.169
        community: public
        oids:
          signal_strength: 1.3.6.1.4.1.2000.5.1
          tx_power: 1.3.6.1.4.1.7352.3.5.10.16.9.0
          rx_power: 1.3.6.1.4.1.7352.3.5.10.16.8.0

    analyzer:
      batch_size: 10
      max_retries: 5
      retry_backoff: 2

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: default
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      - job_name: 'node'
        static_configs:
          - targets: ['node-exporter:9100']

      - job_name: 'kafka'
        static_configs:
          - targets: ['kafka-exporter:9308']

      - job_name: 'rabbitmq'
        static_configs:
          - targets: ['rabbitmq-exporter:9419']

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: telegraf-config
  namespace: default
data:
  telegraf.conf: |
    [agent]
      interval = "1s"
      flush_interval = "1s"
      round_interval = true

    ###############################################################################
    # INPUTS: AMQP Consumer (RabbitMQ)
    ###############################################################################

    # Raw telemetry
    [[inputs.amqp_consumer]]
      url = "${RABBITMQ_URL}"
      queue = "telemetry_raw_queue"
      data_format = "json"
      tag_keys = ["status", "category"]
      json_time_key = "timestamp"
      json_time_format = "unix"
      fielddrop = ["timestamp"]

    # Power telemetry
    [[inputs.amqp_consumer]]
      url = "${RABBITMQ_URL}"
      queue = "telemetry_power_queue"
      data_format = "json"
      tag_keys = ["status", "category"]
      json_time_key = "timestamp"
      json_time_format = "unix"
      fielddrop = ["timestamp"]

    # Health telemetry
    [[inputs.amqp_consumer]]
      url = "${RABBITMQ_URL}"
      queue = "telemetry_health_queue"
      data_format = "json"
      tag_keys = ["status", "category"]
      json_time_key = "timestamp"
      json_time_format = "unix"
      fielddrop = ["timestamp"]

    # Attitude telemetry
    [[inputs.amqp_consumer]]
      url = "${RABBITMQ_URL}"
      queue = "telemetry_attitude_queue"
      data_format = "json"
      tag_keys = ["status", "category"]
      json_time_key = "timestamp"
      json_time_format = "unix"
      fielddrop = ["timestamp"]

    # Environment telemetry
    [[inputs.amqp_consumer]]
      url = "${RABBITMQ_URL}"
      queue = "telemetry_environment_queue"
      data_format = "json"
      tag_keys = ["status", "category"]
      json_time_key = "timestamp"
      json_time_format = "unix"
      fielddrop = ["timestamp"]

    # VSAT telemetry
    [[inputs.amqp_consumer]]
      url = "${RABBITMQ_URL}"
      queue = "telemetry_vsat_queue"
      data_format = "json"
      tag_keys = ["category", "vsat_id", "vsat_ip"]
      json_time_key = "timestamp"
      json_time_format = "unix"
      fielddrop = ["timestamp"]

    ###############################################################################
    # OUTPUTS: InfluxDB
    ###############################################################################

    [[outputs.influxdb]]
      urls = ["${INFLUXDB_URL}"]
      database = "telemetry"
      username = "${INFLUXDB_USERNAME}"
      password = "${INFLUXDB_PASSWORD}"
      timeout = "5s"